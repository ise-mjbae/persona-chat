<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI 페르소나 채팅</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .container {
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            width: 100%;
            max-width: 800px;
            height: 80vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            text-align: center;
        }

        .header h1 {
            font-size: 24px;
            margin-bottom: 10px;
        }

        .settings {
            background: #f8f9fa;
            padding: 20px;
            border-bottom: 1px solid #e9ecef;
        }

        .settings-row {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            align-items: center;
        }

        .settings-row:last-child {
            margin-bottom: 0;
        }

        .settings-row label {
            min-width: 120px;
            font-weight: 600;
            color: #495057;
        }

        .settings-row input, .settings-row textarea, .settings-row select {
            flex: 1;
            padding: 8px 12px;
            border: 1px solid #ced4da;
            border-radius: 6px;
            font-size: 14px;
        }

        .settings-group {
            display: flex;
            gap: 10px;
        }

        .settings-group > div {
            flex: 1;
        }

        .settings-group label {
            min-width: 80px;
            font-size: 12px;
        }

        .settings-row textarea {
            min-height: 80px;
            resize: vertical;
        }

        .chat-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .messages {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            background: #f8f9fa;
        }

        .message {
            margin-bottom: 15px;
            display: flex;
            align-items: flex-start;
            gap: 10px;
        }

        .message.user {
            flex-direction: row-reverse;
        }

        .message .avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            color: white;
            font-size: 14px;
        }

        .message.user .avatar {
            background: #007bff;
        }

        .message.ai .avatar {
            background: #28a745;
        }

        .message .content {
            max-width: 70%;
            background: white;
            padding: 12px 16px;
            border-radius: 18px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            line-height: 1.4;
        }

        .message.user .content {
            background: #007bff;
            color: white;
        }

        .input-area {
            padding: 20px;
            background: white;
            border-top: 1px solid #e9ecef;
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .input-area input {
            flex: 1;
            padding: 12px 16px;
            border: 1px solid #ced4da;
            border-radius: 25px;
            font-size: 14px;
            outline: none;
        }

        .input-area input:focus {
            border-color: #007bff;
        }

        .input-area button {
            background: #007bff;
            color: white;
            border: none;
            border-radius: 50%;
            width: 44px;
            height: 44px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
        }

        .input-area button:hover:not(:disabled) {
            background: #0056b3;
        }

        .input-area button:disabled {
            background: #6c757d;
            cursor: not-allowed;
        }

        .status {
            padding: 10px 20px;
            background: #f8f9fa;
            border-top: 1px solid #e9ecef;
            font-size: 12px;
            color: #6c757d;
            text-align: center;
        }

        .status.speaking {
            background: #d4edda;
            color: #155724;
        }

        @media (max-width: 600px) {
            .container {
                height: 100vh;
                border-radius: 0;
            }
            
            .settings-row {
                flex-direction: column;
                align-items: stretch;
            }
            
            .settings-row label {
                min-width: auto;
                margin-bottom: 5px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>AI 페르소나 채팅</h1>
            <p>상황 설정에 맞춰 AI와 대화해보세요</p>
        </div>

        <div class="settings">
            <div class="settings-row">
                <label>OpenAI API:</label>
                <input type="password" id="openai-key" placeholder="OpenAI API 키를 입력하세요">
            </div>
            <div class="settings-row">
                <label>Typecast API:</label>
                <input type="password" id="typecast-key" placeholder="Typecast API 키를 입력하세요">
            </div>
            <div class="settings-row">
                <label>Actor ID:</label>
                <input type="text" id="actor-id" placeholder="Typecast Actor ID (24자리)를 입력하세요">
            </div>
            <div class="settings-row">
                <div class="settings-group">
                    <div>
                        <label>Tempo:</label>
                        <input type="number" id="tempo" min="0.5" max="2" step="0.1" value="1" placeholder="1">
                    </div>
                    <div>
                        <label>Volume:</label>
                        <input type="number" id="volume" min="0" max="100" value="100" placeholder="100">
                    </div>
                    <div>
                        <label>Pitch:</label>
                        <input type="number" id="pitch" min="-10" max="10" value="0" placeholder="0">
                    </div>
                    <div>
                        <label>감정톤:</label>
                        <select id="emotion-tone">
                            <option value="auto">Auto</option>
                            <option value="normal-1" selected>Normal</option>
                            <option value="happy-1">Happy</option>
                            <option value="sad-1">Sad</option>
                            <option value="angry-1">Angry</option>
                        </select>
                    </div>
                </div>
            </div>
            <div class="settings-row">
                <label>상황 설정:</label>
                <textarea id="scenario" placeholder="AI가 연기할 상황이나 역할을 설정하세요. 예: 당신은 친근한 카페 사장입니다. 손님들과 일상적인 대화를 나누며..."></textarea>
            </div>
        </div>

        <div class="chat-container">
            <div class="messages" id="messages"></div>
            
            <div class="input-area">
                <input type="text" id="user-input" placeholder="메시지를 입력하세요..." maxlength="500">
                <button id="send-btn">➤</button>
            </div>
        </div>

        <div class="status" id="status">API 키와 상황 설정을 입력하고 대화를 시작하세요</div>
    </div>

    <script>
        class PersonaChatApp {
            constructor() {
                this.initElements();
                this.initEventListeners();
                this.loadSettings();
                this.isSpeaking = false;
                this.conversationHistory = [];
            }

            initElements() {
                this.openaiKeyInput = document.getElementById('openai-key');
                this.typecastKeyInput = document.getElementById('typecast-key');
                this.actorIdInput = document.getElementById('actor-id');
                this.tempoInput = document.getElementById('tempo');
                this.volumeInput = document.getElementById('volume');
                this.pitchInput = document.getElementById('pitch');
                this.emotionToneInput = document.getElementById('emotion-tone');
                this.scenarioInput = document.getElementById('scenario');
                this.messagesContainer = document.getElementById('messages');
                this.userInput = document.getElementById('user-input');
                this.sendBtn = document.getElementById('send-btn');
                this.status = document.getElementById('status');
            }

            initEventListeners() {
                this.sendBtn.addEventListener('click', () => this.sendMessage());
                this.userInput.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter' && !e.shiftKey) {
                        e.preventDefault();
                        this.sendMessage();
                    }
                });

                [this.openaiKeyInput, this.typecastKeyInput, this.actorIdInput, this.tempoInput, this.volumeInput, this.pitchInput, this.emotionToneInput, this.scenarioInput].forEach(input => {
                    input.addEventListener('input', () => this.saveSettings());
                    input.addEventListener('change', () => this.saveSettings());
                });
            }

            loadSettings() {
                this.openaiKeyInput.value = localStorage.getItem('openai-key') || '';
                this.typecastKeyInput.value = localStorage.getItem('typecast-key') || '';
                this.actorIdInput.value = localStorage.getItem('actor-id') || '';
                this.tempoInput.value = localStorage.getItem('tempo') || '1';
                this.volumeInput.value = localStorage.getItem('volume') || '100';
                this.pitchInput.value = localStorage.getItem('pitch') || '0';
                this.emotionToneInput.value = localStorage.getItem('emotion-tone') || 'normal-1';
                this.scenarioInput.value = localStorage.getItem('scenario') || '';
            }

            saveSettings() {
                localStorage.setItem('openai-key', this.openaiKeyInput.value);
                localStorage.setItem('typecast-key', this.typecastKeyInput.value);
                localStorage.setItem('actor-id', this.actorIdInput.value);
                localStorage.setItem('tempo', this.tempoInput.value);
                localStorage.setItem('volume', this.volumeInput.value);
                localStorage.setItem('pitch', this.pitchInput.value);
                localStorage.setItem('emotion-tone', this.emotionToneInput.value);
                localStorage.setItem('scenario', this.scenarioInput.value);
            }

            addMessage(content, isUser = false) {
                const messageDiv = document.createElement('div');
                messageDiv.className = `message ${isUser ? 'user' : 'ai'}`;
                
                messageDiv.innerHTML = `
                    <div class="avatar">${isUser ? 'YOU' : 'AI'}</div>
                    <div class="content">${content}</div>
                `;
                
                this.messagesContainer.appendChild(messageDiv);
                this.messagesContainer.scrollTop = this.messagesContainer.scrollHeight;
            }

            setInputEnabled(enabled) {
                this.userInput.disabled = !enabled;
                this.sendBtn.disabled = !enabled;
                
                if (enabled) {
                    this.userInput.focus();
                    this.status.textContent = '메시지를 입력하세요';
                    this.status.className = 'status';
                }
            }

            setStatus(message, isSpeaking = false) {
                this.status.textContent = message;
                this.status.className = isSpeaking ? 'status speaking' : 'status';
            }

            async sendMessage() {
                const message = this.userInput.value.trim();
                if (!message || this.isSpeaking) return;

                const openaiKey = this.openaiKeyInput.value.trim();
                const typecastKey = this.typecastKeyInput.value.trim();
                const actorId = this.actorIdInput.value.trim();
                const scenario = this.scenarioInput.value.trim();

                if (!openaiKey || !typecastKey || !actorId || !scenario) {
                    alert('모든 설정을 입력해주세요.');
                    return;
                }

                this.addMessage(message, true);
                this.conversationHistory.push({ role: 'user', content: message });
                this.userInput.value = '';
                this.setInputEnabled(false);
                this.setStatus('AI가 응답을 생성중입니다...');

                try {
                    const aiResponse = await this.callOpenAI(openaiKey, scenario);
                    this.addMessage(aiResponse);
                    this.conversationHistory.push({ role: 'assistant', content: aiResponse });
                    
                    this.setStatus('음성을 생성중입니다...');
                    
                    // 감정톤 자동 선택
                    let emotionTone = this.emotionToneInput.value;
                    if (emotionTone === 'auto') {
                        this.setStatus('감정톤을 분석중입니다...');
                        emotionTone = await this.getEmotionTone(openaiKey, aiResponse);
                    }
                    
                    await this.generateAndPlayAudio(typecastKey, actorId, aiResponse, emotionTone);
                    
                } catch (error) {
                    console.error('Error:', error);
                    this.addMessage('죄송합니다. 오류가 발생했습니다: ' + error.message);
                    this.setInputEnabled(true);
                }
            }

            async callOpenAI(apiKey, scenario) {
                const messages = [
                    { role: 'system', content: scenario },
                    ...this.conversationHistory
                ];

                const response = await fetch('https://api.openai.com/v1/chat/completions', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${apiKey}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        model: 'gpt-3.5-turbo',
                        messages: messages,
                        max_tokens: 500,
                        temperature: 0.7
                    })
                });

                if (!response.ok) {
                    throw new Error(`OpenAI API 오류: ${response.status}`);
                }

                const data = await response.json();
                return data.choices[0].message.content;
            }

            async getEmotionTone(apiKey, aiResponse) {
                try {
                    const response = await fetch('https://api.openai.com/v1/chat/completions', {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${apiKey}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            model: 'gpt-3.5-turbo',
                            messages: [
                                {
                                    role: 'system',
                                    content: '다음 텍스트의 감정을 분석하여 음성 생성에 적합한 감정톤을 선택해주세요. 다음 중 하나만 선택하세요: normal-1, happy-1, sad-1, angry-1. 답변은 선택한 감정톤만 출력하세요.'
                                },
                                {
                                    role: 'user',
                                    content: `대화 맥락: ${this.conversationHistory.slice(-3).map(m => `${m.role}: ${m.content}`).join('\n')}\n\n분석할 텍스트: ${aiResponse}`
                                }
                            ],
                            max_tokens: 50,
                            temperature: 0.3
                        })
                    });

                    if (response.ok) {
                        const data = await response.json();
                        const selectedTone = data.choices[0].message.content.trim();
                        const validTones = ['normal-1', 'happy-1', 'sad-1', 'angry-1'];
                        return validTones.includes(selectedTone) ? selectedTone : 'normal-1';
                    }
                } catch (error) {
                    console.error('감정톤 분석 오류:', error);
                }
                return 'normal-1';
            }

            async generateAndPlayAudio(apiKey, actorId, text, emotionTone = 'normal-1') {
                try {
                    console.log(`apiKey :${apiKey}`)   
                    console.log(`actorId :${actorId}`)   
                    console.log(`text :${text}`)   
                    
                    // 1단계: /api/speak 호출하여 speak_v2_url 획득
                    const speakResponse = await fetch('https://typecast.ai/api/speak', {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${apiKey}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            actor_id: actorId,
                            text: text,
                            lang: 'auto',
                            model_version: 'latest',
                            xapi_hd: true,
                            tempo: parseFloat(this.tempoInput.value) || 1,
                            volume: parseInt(this.volumeInput.value) || 100,
                            pitch: parseInt(this.pitchInput.value) || 0,
                            max_seconds: 60,
                            xapi_audio_format: 'wav',
                            emotion_tone_preset: emotionTone
                        })
                    });

                    if (!speakResponse.ok) {
                        throw new Error(`Typecast API 오류: ${speakResponse.status}`);
                    }

                    const speakData = await speakResponse.json();
                    const speakV2Url = speakData.result.speak_v2_url;
                    
                    if (!speakV2Url) {
                        throw new Error('speak_v2_url을 받지 못했습니다.');
                    }
                    
                    this.setStatus('음성 파일을 처리중입니다...');
                    
                    // 2단계: speak_v2_url로 GET 요청하여 audio_download_url 획득
                    let audioDownloadUrl = null;
                    let attempts = 0;
                    const maxAttempts = 30; // 최대 30초 대기
                    
                    while (!audioDownloadUrl && attempts < maxAttempts) {
                        await new Promise(resolve => setTimeout(resolve, 1000)); // 1초 대기
                        
                        const statusResponse = await fetch(speakV2Url, {
                            method: 'GET',
                            headers: {
                                'Authorization': `Bearer ${apiKey}`,
                                'Content-Type': 'application/json'
                            }
                        });
                        
                        if (statusResponse.ok) {
                            const statusData = await statusResponse.json();
                            
                            if (statusData.result.status === 'done' && statusData.result.audio_download_url) {
                                audioDownloadUrl = statusData.result.audio_download_url;
                            } else if (statusData.result.status === 'error') {
                                throw new Error('음성 생성에 실패했습니다.');
                            }
                        }
                        
                        attempts++;
                    }
                    
                    if (!audioDownloadUrl) {
                        throw new Error('음성 생성 시간이 초과되었습니다.');
                    }
                    
                    // 3단계: audio_download_url에서 최종 음성 파일 다운로드
                    const audioResponse = await fetch(audioDownloadUrl);
                    
                    if (!audioResponse.ok) {
                        throw new Error(`음성 파일 다운로드 실패: ${audioResponse.status}`);
                    }
                    
                    const audioBlob = await audioResponse.blob();
                    const audioUrl = URL.createObjectURL(audioBlob);
                    
                    return new Promise((resolve, reject) => {
                        this.isSpeaking = true;
                        this.setStatus('음성을 재생중입니다...', true);
                        
                        const audio = new Audio(audioUrl);
                        
                        audio.onended = () => {
                            this.isSpeaking = false;
                            this.setInputEnabled(true);
                            URL.revokeObjectURL(audioUrl);
                            resolve();
                        };
                        
                        audio.onerror = (error) => {
                            this.isSpeaking = false;
                            this.setInputEnabled(true);
                            URL.revokeObjectURL(audioUrl);
                            reject(error);
                        };
                        
                        audio.play().catch(reject);
                    });
                    
                } catch (error) {
                    console.error('Typecast API 오류:', error);
                    this.setStatus('음성 생성 실패, Web Speech API로 대체합니다...');
                    
                    return new Promise((resolve, reject) => {
                        if ('speechSynthesis' in window) {
                            this.isSpeaking = true;
                            this.setStatus('음성을 재생중입니다...', true);
                            
                            const utterance = new SpeechSynthesisUtterance(text);
                            utterance.lang = 'ko-KR';
                            utterance.rate = 0.9;
                            
                            utterance.onend = () => {
                                this.isSpeaking = false;
                                this.setInputEnabled(true);
                                resolve();
                            };
                            
                            utterance.onerror = (error) => {
                                this.isSpeaking = false;
                                this.setInputEnabled(true);
                                reject(error);
                            };
                            
                            speechSynthesis.speak(utterance);
                        } else {
                            this.setInputEnabled(true);
                            resolve();
                        }
                    });
                }
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            new PersonaChatApp();
        });
    </script>
</body>
</html>